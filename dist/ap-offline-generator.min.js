"use strict";angular.module("angularPoint").controller("generateOfflineCtrl",["$scope","$q","apDataService","apConfig","apExportService","toastr",function(a,b,c,d,e,f){function g(){h(),a.$watch("state.selectedList",function(b){b&&(q.fileName=q.selectedList.Title.replace(" ","")+".xml",a.lookupListFields(),console.log(b))})}function h(){a.listCollection.length=0,c.getCollection({operation:"GetListCollection",webURL:q.siteUrl}).then(function(b){a.listCollection.push.apply(a.listCollection,b),f.info(a.listCollection.length+" lists/libraries identified.")})}function i(a){return a.replace(/'+/g,"").replace(/\++/g,"")}function j(){q.xmlResponse="";var a={operation:q.operation,listName:q.selectedList.ID,CAMLRowLimit:q.itemLimit,offlineXML:d.offlineXML+q.fileName,CAMLQueryOptions:"",webURL:q.siteUrl};q.selectedListFields.length>0&&(a.CAMLViewFields="<ViewFields>",_.each(q.selectedListFields,function(b){a.CAMLViewFields+="<FieldRef Name='"+b+"' />"}),a.CAMLViewFields+="</ViewFields>");var b=i(q.query);b.length>0&&(a.CAMLQuery=b),a.CAMLQueryOptions=k(p),c.serviceWrapper(a).then(function(a){q.xmlResponse=(new XMLSerializer).serializeToString(a)})}function k(a){var b="<QueryOptions>";return _.each(a,function(a){b+="<"+a.attr+">"+(a.val?"TRUE":"FALSE")+"</"+a.attr+">"}),b+="</QueryOptions>"}function l(a){a.target.select()}function m(){console.log("Looking up List Fields"),q.availableListFields.length=0,q.selectedListFields.length=0,_.isObject(q.selectedList)&&q.selectedList.Title?c.getListFields({listName:q.selectedList.Name}).then(function(a){q.availableListFields.push.apply(q.availableListFields,a),f.info(q.availableListFields.length+" fields found.")}):f.error("Please ensure a list is selected before preceding.")}function n(){e.saveXML(q.xmlResponse,q.fileName)}var o=["GetListItemChangesSinceToken","GetListItems"],p=[{attr:"IncludeMandatoryColumns",val:!1},{attr:"IncludeAttachmentUrls",val:!0},{attr:"IncludeAttachmentVersion",val:!1},{attr:"ExpandUserField",val:!1}],q={availableListFields:[],fileName:"",itemLimit:0,operation:o[0],query:"",selectedList:"",selectedListFields:[],siteUrl:d.defaultUrl,xmlResponse:""};a.listCollection=[],a.lookupListFields=m,a.getLists=h,a.getXML=j,a.onTextClick=l,a.operations=o,a.queryOptions=p,a.saveXML=n,a.state=q,g()}]),angular.module("angularPoint").run(["$templateCache",function(a){a.put("bower_components/angular-point-offline-generator/src/ap-offline-generator-view.html",'<div class=container><h3>Offline XML Generator</h3><p>Fill in the basic information for a list and make the request to SharePoint. The xml response will appear at the bottom of the page where you can then copy by Ctrl + A.</p><hr><form role=form><div class=form-group><label>Site URL</label><div class=input-group><input type=url class=form-control ng-model=state.siteUrl> <span class=input-group-btn><button title="Refresh list/libraries" class="btn btn-success" type=button ng-click=getLists()><i class="fa fa-refresh"></i></button></span></div></div><div class=row><div class=col-xs-5><div class=form-group><label>List Name or GUID</label><select ng-model=state.selectedList ng-options="list.Title for list in listCollection" class=form-control></select></div></div><div class=col-xs-3><div class=form-group><label>Number of Items to Return</label><input type=number class=form-control ng-model=state.itemLimit><p class=help-block>[0 = All Items]</p></div></div><div class=col-xs-4><div class=form-group><label>Operation</label><select class=form-control ng-model=state.operation ng-options="operation for operation in operations"></select><p class=help-block>Operation to query with.</p></div></div></div><div class=row><div class=col-xs-12><div class=form-group><label>Selected Fields</label><div ui-select multiple ng-model=state.selectedListFields theme=bootstrap ng-disabled="listCollection.length < 1 || !state.selectedList"><div ui-select-match placeholder="Select fields to include...">{{$item.Name}}</div><div ui-select-choices repeat="field in state.availableListFields">{{ field.Name }}</div></div><p class=help-block>Leaving this blank will return all fields visible in the default list view.</p></div></div></div><fieldset><legend>Query Options</legend><div class=row><div class=col-xs-3 ng-repeat="option in queryOptions"><div class=form-group><label>{{ option.attr }}</label><input type=checkbox ng-model=option.val class=form-control></div></div></div></fieldset><div class=form-group><label>CAML Query (Optional)</label><textarea class=form-control ng-model=state.query rows=3></textarea></div><div class=row><div class=col-xs-6><div class=form-group><button type=submit class="btn btn-primary" ng-click=getXML()>Make Request</button></div></div><div class=col-xs-6><fieldset ng-disabled="state.xmlResponse.length < 1"><div class=form-group><div class=input-group><input class=form-control ng-model=state.fileName> <span class=input-group-btn><button class="btn btn-success" ng-click=saveXML()>Save XML</button></span></div></div></fieldset></div></div><br><hr><h4>XML Response</h4><ol><li>Create a new offline file under the identified in apConfig.offlineXML (defaults to: "app/dev")</li><li>Use the same name as found in the model at "model.list.title" + .xml</li><li>Select the returned XML below by clicking in the textarea.</li><li>Add the XML to the newly created offline .xml file.</li></ol><div class="well well-sm"><textarea name=xmlResponse class=form-control cols=30 rows=10 ng-model=state.xmlResponse ng-click=onTextClick($event)></textarea></div></form></div>')}]);